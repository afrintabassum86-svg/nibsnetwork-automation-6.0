name: Deploy to EC2 Self-Hosted Runner

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - uses: actions/checkout@v3

    - name: Setup System Node.js 20.x (Global)
      run: |
        # Check if node is installed and is version 20
        if ! command -v node &> /dev/null || [[ $(node -v) != v20* ]]; then
          echo "Installing Node.js 20.x globally..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
        else
          echo "Node.js 20.x is already installed globally."
        fi
        node -v
        npm -v

    - name: Install Global Dependencies (PM2)
      run: |
        sudo npm install -g pm2
        pm2 -v

    - name: Install Project Dependencies
      run: npm ci

    - name: Build Frontend
      run: npm run build

    - name: Start/Restart Application with PM2
      run: |
        # Start the app
        if pm2 list | grep -q "nibs-server"; then
          pm2 restart nibs-server
        else
          pm2 start admin-server.js --name nibs-server
        fi
        
        # Save the process list so it respawns on reboot
        pm2 save
        
        # Ensure PM2 generates the startup script (idempotent)
        sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
